 # ワークスペースの状態遷移

ワークスペースはユーザの操作とその完了イベントによって状態を遷移します。
 
- 状態遷移図の遷移のテキストで **（操作）** となっているものはユーザがダッシュボードのボタンを押して操作することを意味しています。 
- 状態遷移図の遷移のテキストで **（イベント）** となっているものは操作の完了時に状態を遷移させることを意味しています。
- 状態遷移図で **（操作）** の遷移がないものについてはユーザはその操作を実行できず、ダッシュボードではその操作のボタンは無効化されます。
- 状態はデータベース上のワークスペースのテーブルで管理されます。
- 新規追加（操作）でレコードが追加され、削除完了（イベント）でレコードが削除されます。
- 状態を変更する場合はその前提となる変更前操作を指定してレコードをアトミックに変更します。これにより、更新競合を回避します。前提状態が一致せずレコードの更新に失敗した場合、操作の場合はユーザに操作できなかったことを通知し、イベントによる遷移の場合はバグの可能性があるという趣旨のエラーログを出力します。
- 占有状態はユーザがワークスペースを占有していることをあらわし、レコードのユーザ名フィールドにユーザIDが入ります
- 停止ではワークスペースが共有されており、レコードのユーザ名フィールドは null になります。
- ダッシュボードのワークスペース一覧には自分が占有しているワークスペースと停止のワークスペースが表示されます。 
- ダッシュボードのワークスペース一覧は他のユーザの操作によって占有状態<->停止の遷移があった場合、リストを更新してワークスペースを増減させます。

 ```mermaid
 stateDiagram-v2
    [*] --> 占有状態: 新規追加（操作）
    state 占有状態 {
        [*] --> ビルド中: 新規追加（操作）
        [*] --> 起動中:  取得（操作）
        [*] --> 削除中: 削除（操作）
        ビルド中 --> 実行中: ビルド成功（イベント）
        ビルド中 --> 失敗: ビルド失敗（イベント）
        起動中 --> 実行中: 起動成功（イベント）
        起動中 --> 失敗: 起動失敗（イベント）
        実行中 --> 停止中: 解放（操作）
        停止中 --> [*]: 停止完了（イベント）
        実行中 --> 削除中: 削除（操作）
        削除中 --> [*]: 削除完了（イベント）
        失敗 --> 削除中: 削除（操作）
    }
    占有状態 --> 停止: 停止完了（イベント）
    停止 --> 占有状態: 取得（操作）
    停止 --> 占有状態: 削除（操作）
    占有状態 --> [*]: 削除完了（イベント）
```